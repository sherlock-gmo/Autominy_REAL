#! /usr/bin/env python
import cv2
import rospy
import numpy as np

#*************************************************************************************************************
#*************************************************************************************************************
#*************************************************************************************************************
#  		               TIP
def tip(imagenN):
	H=np.array([[-4.51935893e-01,-1.59213448,2.29943094e+02],[-1.49372457e-01,-5.42175253,6.00556357e+02],[-4.31688088e-04,-1.60028341e-02,1.0]])
	imagenH = cv2.warpPerspective(imagenN, H, (200,300),borderMode=cv2.BORDER_CONSTANT, borderValue=(0, 0, 0))
	return imagenH
#*************************************************************************************************************
#*************************************************************************************************************
#*************************************************************************************************************
def roi_zone(x):
	assert (x>=0) and (x<=199), 'x out of limits'
	if (x>119) and (x<=199):
		y = int(round(-1.975*x+534.025))
	if (x>=80) and (x<=119):
		y = 299
	if (x>=0) and (x<80):
		y = int(round(2.0*x+139.0))
	return y
#*************************************************************************************************************
#*************************************************************************************************************
#*************************************************************************************************************
def vec_create(x,stride,side):
	if(side==1):
		# D
		xi = x+stride
		xd = x-stride
	if(side==-1): #else:
		# I
		xi = x-stride
		xd = x+stride
	if(xi<0): xi = 0
	if(xi>199): xi = 199
	if(xd<0): xd = 0 #xi
	if(xd>199): xd = 199 #xi
	xv = np.arange(xi,xd,(-1)*side)
	return xv
#*************************************************************************************************************
#*************************************************************************************************************
#*************************************************************************************************************
def line_detector(imagen0,x1,l,side):
	K = True
	stridex = 30 #25 #12
	stridey = 25 #25 #12
	y1 = roi_zone(x1)
	x1v = vec_create(x1,stridex,side)
	while (K==True):
		m = y1+stridey
		if (m>=299): m = 299
		for j in range(m,y1-stridey,-1):
			for i in x1v:
				if imagen0[j][i]==255:
					x1 = i
					y1 = j
					K = False
					break
			#x1v = vec_create(x1,stridex,side)
			if (K==False): break
		if (K==True):
			x1 = x1-1*side
			y1 = roi_zone(x1)
			x1v = vec_create(x1,stridex,side)
	x2 = x1
	x2v = vec_create(x2,stridex,side)
	for j in range(y1-1,y1-l,-1):
		for i in x2v:
			if imagen0[j][i]==255:
				x2 = i
				y2 = j
				#K = False
				break
		x2v = vec_create(x2,stridex,side)
	return x1,y1,x2,y2
#*************************************************************************************************************
#*************************************************************************************************************
#*************************************************************************************************************
def vis_cam(imagenF,x1,x2,y1,y2):
		imagenS = cv2.cvtColor(self.imagenF,cv2.COLOR_GRAY2BGR)
		imagenS = cv2.circle(imagenS,(x1,y1),3,(0, 0, 255),-1)
		imagenS = cv2.circle(imagenS,(x2,y2),3,(0, 0, 255),-1)
		imagenS = cv2.line(imagenS, (x1,y1), (x2,y2), (0, 0, 255), 2)
		cv2.imshow('homografia',imagenS)
		#cv2.moveWindow("homografia", 400,20)
		cv2.waitKey(1)
#*************************************************************************************************************
#*************************************************************************************************************
#*************************************************************************************************************

